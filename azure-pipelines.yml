# Maven
# Build your Java project and run tests with Apache Maven.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
  branches:
    include:
    - "*"

jobs:
- job: build
  displayName: "Build"

  strategy:
    matrix:
      Java8:
        jdk_version: 1.8
        artifact_suffix: '-Java8'
      Java11:
        jdk_version: 1.11
        artifact_suffix: ''

  pool:
    vmImage: ubuntu-16.04
  variables:
    JAVA_TOOL_OPTIONS: "-XX:+UseG1GC"  # No aggressive opts in JDK 11
    jdk_version: 1.8
    artifact_suffix: ' (Java 8)'
  steps:
  - template: etc/azure-templates/build.yml
  - template: etc/azure-templates/publish-artifacts.yml
- job: build-java11
  displayName: "Build (Java 11)"
  pool:
    vmImage: ubuntu-16.04
  variables:
    JAVA_TOOL_OPTIONS: "-XX:+UseG1GC"  # No aggressive opts in JDK 11
    jdk_version: 1.11
    artifact_suffix: ''
  steps:
  - template: etc/azure-templates/build.yml
  - task: PublishCodeCoverageResults@1
    displayName: "Publish Coverage Results"

    inputs:
      codeCoverageTool: "jaCoCo"
      summaryFileLocation: "$(System.DefaultWorkingDirectory)/target/site/jacoco/jacoco.xml"
      reportDirectory: "$(System.DefaultWorkingDirectory)/target/site/jacoco"
      additionalCodeCoverageFiles: "$(System.DefaultWorkingDirectory)/**/jacoco.exec"
      failIfCoverageEmpty: false

  - task: PublishPipelineArtifact@0
    displayName: "Artifact: Glowstone"

    inputs:
      artifactName: 'Glowstone'
      targetPath: 'target/glowstone$(artifact_suffix).jar'
      publishLocation: 'container'

  - task: PublishPipelineArtifact@0
    displayName: "Artifact: JavaDoc JAR"

    inputs:
      artifactName: 'JavaDoc JAR'
      targetPath: 'target/glowstone-javadoc$(artifact_suffix).jar'
      publishLocation: 'container'

  - task: PublishPipelineArtifact@0
    displayName: "Artifact: Sources JAR"

    inputs:
      artifactName: 'Sources JAR'
      targetPath: 'target/glowstone-sources$(artifact_suffix).jar'
      publishLocation: 'container'
